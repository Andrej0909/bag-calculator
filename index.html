<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bag Calculator</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            margin: 20px;
            font-size: 25px;
        }
        table {
            width: 90vw;
            margin: 0 auto;
            table-layout: fixed;
            border-collapse: collapse;
        }
        th, td {
            border: 3px solid #ddd;
            height: 80px;
            width: 25%;
            padding: 0;
            text-align: center;
        }

        input {
            width: 100%;
            height: 100%;
            font-size: 25px;
            text-align: center;
            background-color: #e0f3ff;
            border: 3px solid #2b2b2b;
            
        }

        /* Readonly inputs for calculated values */
        input[readonly] {
            background-color: #f0f0f0;
            color: #666;
        }

        /* Style for the result number next to the title */
        #result {
            font-size: 30px;
            position: absolute;
            right: 40px;
            top: 60px;
        }

        /* Style for calculated cells */
        .calculated-cell {
            background-color: #f9f9f9;
            font-weight: bold;
            vertical-align: middle;
            padding: 20px;
            font-size: 25px;
        }
    </style>
</head>
<body>
    <h1>Bag Calculator <span id="result"></span></h1>

    <!-- First row of the table -->
    <table>
        <tr>
            <th> </th>
            <th>Percent</th>
            <th>PCS</th>
            <th>Kg</th>
        </tr>
        <!-- Second row of the table -->
        <tr>
            <td>Total</td>
            <th> </th>
            <td>
                <input type="number" id="totalPcs" placeholder="Enter Total PCS" min="1"><br><br>
            </td>
            <td>
                <input type="number" id="totalKg" placeholder="Enter Total Kg" min="0.1" step="0.1"><br><br>
            </td>
        </tr>
        <!-- Third row of the table -->
        <tr>
            <td>Comp 1:</td>
            <td>
                <input type="number" id="percent1" placeholder="Enter %" min="0" max="100" step="1" value="30">
            </td>
            <td>
                <input type="number" id="pcs1" placeholder="Enter PCS" min="0">
            </td>
            <td class="calculated-cell" id="kg1Display">0</td>
        </tr>
        <!-- Fourth row of the table -->
        <tr>
            <td>Comp 3:</td>
            <td class="calculated-cell" id="percent3Display">40%</td>
            <td class="calculated-cell" id="pcs3Display">0</td>
            <td class="calculated-cell" id="kg3Display">0</td>
        </tr>
        <!-- Fifth row of the table -->
        <tr>
            <td>Comp 4:</td>
            <td>
                <input type="number" id="percent4" placeholder="Enter %" min="0" max="100" step="1" value="30">
            </td>
            <td>
                <input type="number" id="pcs4" placeholder="Enter PCS" min="0">
            </td>
            <td class="calculated-cell" id="kg4Display">0</td>
        </tr>
    </table>

    <script>
        // Smart calculation for 3-compartment system (Comp1, Comp3, Comp4)
        function calculate() {
            const totalPcs = parseFloat(document.getElementById('totalPcs').value) || 0;
            const totalKg = parseFloat(document.getElementById('totalKg').value) || 0;

            // Validate inputs
            if (totalPcs <= 0 || totalKg <= 0) {
                clearResults();
                return;
            }

            // Calculate weight per bag
            const kgPerBag = totalKg / totalPcs;

            // Get input values for Comp1 and Comp4
            const pcs1 = parseFloat(document.getElementById('pcs1').value) || 0;
            const pcs4 = parseFloat(document.getElementById('pcs4').value) || 0;
            const percent1 = parseFloat(document.getElementById('percent1').value) || 0;
            const percent4 = parseFloat(document.getElementById('percent4').value) || 0;

            let actualPcs1, actualPcs3, actualPcs4;
            let actualPercent1, actualPercent3, actualPercent4;

            // Determine which inputs have values to decide calculation mode
            const hasPcsInput = pcs1 > 0 || pcs4 > 0;
            const hasCustomPercent = (percent1 > 0 && percent1 !== 30) || (percent4 > 0 && percent4 !== 30);
            const hasPercentInput = hasCustomPercent;

            if (hasPcsInput && !hasPercentInput) {
                // PCS mode - calculate percentages from PCS values
                actualPcs1 = Math.min(pcs1, totalPcs);
                actualPcs4 = Math.min(pcs4, totalPcs - actualPcs1);
                actualPcs3 = totalPcs - actualPcs1 - actualPcs4;

                // Calculate percentages from PCS
                actualPercent1 = totalPcs > 0 ? Math.round((actualPcs1 / totalPcs) * 100) : 0;
                actualPercent4 = totalPcs > 0 ? Math.round((actualPcs4 / totalPcs) * 100) : 0;
                actualPercent3 = 100 - actualPercent1 - actualPercent4;

                // Update Percent inputs with calculated values
                document.getElementById('percent1').value = actualPercent1;
                document.getElementById('percent4').value = actualPercent4;

                // Visual feedback for over-allocation
                const isOverAllocated = (pcs1 + pcs4) > totalPcs;
                document.getElementById('pcs1').style.borderColor = isOverAllocated ? '#ff4444' : '#2b2b2b';
                document.getElementById('pcs4').style.borderColor = isOverAllocated ? '#ff4444' : '#2b2b2b';
                document.getElementById('percent1').style.borderColor = '#2b2b2b';
                document.getElementById('percent4').style.borderColor = '#2b2b2b';

            } else if (hasPercentInput && !hasPcsInput) {
                // Percent mode - calculate PCS from percentage values
                actualPercent1 = percent1;
                actualPercent4 = percent4;
                actualPercent3 = 100 - actualPercent1 - actualPercent4;

                // Calculate PCS from percentages
                actualPcs1 = Math.round((actualPercent1 / 100) * totalPcs);
                actualPcs4 = Math.round((actualPercent4 / 100) * totalPcs);
                actualPcs3 = totalPcs - actualPcs1 - actualPcs4;

                // Visual feedback for over-allocation
                const isOverAllocated = (percent1 + percent4) > 100;
                document.getElementById('percent1').style.borderColor = isOverAllocated ? '#ff4444' : '#2b2b2b';
                document.getElementById('percent4').style.borderColor = isOverAllocated ? '#ff4444' : '#2b2b2b';
                document.getElementById('pcs1').style.borderColor = '#2b2b2b';
                document.getElementById('pcs4').style.borderColor = '#2b2b2b';

            } else {
                // Use default values or current values from input fields
                actualPercent1 = percent1 || 30;
                actualPercent4 = percent4 || 30;
                actualPercent3 = 100 - actualPercent1 - actualPercent4;

                actualPcs1 = Math.round((actualPercent1 / 100) * totalPcs);
                actualPcs4 = Math.round((actualPercent4 / 100) * totalPcs);
                actualPcs3 = totalPcs - actualPcs1 - actualPcs4;

                // Update PCS fields to show calculated values when using default percentages
                if (!pcs1 && !pcs4) {
                    document.getElementById('pcs1').value = actualPcs1;
                    document.getElementById('pcs4').value = actualPcs4;
                }
            }

            // Calculate weights
            const kg1 = Math.round((actualPcs1 * kgPerBag).toFixed(2));
            const kg4 = Math.round((actualPcs4 * kgPerBag).toFixed(2));
            const kg3 = totalKg-kg1-kg4;

            // Update display
            document.getElementById('result').innerHTML = "<strong>" + kgPerBag.toFixed(2) + "</strong> kg/bag";

            // Update Comp 3 display (always calculated)
            document.getElementById('percent3Display').textContent = actualPercent3 + "%";
            document.getElementById('pcs3Display').textContent = actualPcs3;

            // Update weights
            document.getElementById('kg1Display').textContent = kg1;
            document.getElementById('kg3Display').textContent = kg3;
            document.getElementById('kg4Display').textContent = kg4;
        }

        // Function to clear results when inputs are invalid
        function clearResults() {
            document.getElementById('result').innerHTML = "";
            document.getElementById('percent3Display').textContent = "40%";
            document.getElementById('pcs3Display').textContent = "0";
            document.getElementById('kg1Display').textContent = "0";
            document.getElementById('kg3Display').textContent = "0";
            document.getElementById('kg4Display').textContent = "0";
        }

        // Event listeners for 3-compartment system
        document.getElementById('totalPcs').addEventListener('input', calculate);
        document.getElementById('totalKg').addEventListener('input', calculate);
        
        // Comp1 input listeners
        document.getElementById('pcs1').addEventListener('input', function() {
            if (this.value !== '') {
                document.getElementById('percent1').value = '';
                document.getElementById('percent4').value = '';
            }
            calculate();
        });
        
        document.getElementById('percent1').addEventListener('input', function() {
            if (this.value !== '') {
                document.getElementById('pcs1').value = '';
                document.getElementById('pcs4').value = '';
            }
            calculate();
        });
        
        // Comp4 input listeners
        document.getElementById('pcs4').addEventListener('input', function() {
            if (this.value !== '') {
                document.getElementById('percent1').value = '';
                document.getElementById('percent4').value = '';
            }
            calculate();
        });
        
        document.getElementById('percent4').addEventListener('input', function() {
            if (this.value !== '') {
                document.getElementById('pcs1').value = '';
                document.getElementById('pcs4').value = '';
            }
            calculate();
        });

        // Initialize with default percentages and trigger calculation if totals exist
        clearResults();
        
        // Trigger initial calculation to show default split when totals are entered
        calculate();

        // Service Worker registration
        async function registerServiceWorker() {
            if ("serviceWorker" in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register("sw.js");
                    console.log("Service Worker registered with scope:", registration.scope);
                } catch (error) {
                    console.error("Service Worker registration failed:", error);
                }
            }
        }

        registerServiceWorker();
    </script>
</body>
</html>
